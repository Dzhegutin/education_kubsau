<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создание теста</title>
    {% load static %}
    <link rel="icon" href="{% static 'exam/icons/logo1.svg' %}">
    <link rel="stylesheet" href="{% static 'exam/css/create_test.css' %}">
</head>
<body>
    <header class="header">
        <div class="title-form">
            <img src="{% static 'exam/icons/logo.svg' %}" alt="logo" class="header-logo-image" width="61" height="50" loading="lazy"/>
            ExamPro
        </div>
        <nav class="header-menu">
            <ul class="header-menu-list">
                <li class="header-menu-item">
                    <a class="header-menu-link" href="/my_authors">Мои авторы</a>
                </li>
                <li class="header-menu-item">
                    <a class="header-menu-link" href="/my_tests">Мои тесты</a>
                </li>
                <li class="header-menu-item">
                    <a class="header-menu-link" href="/account">Аккаунт</a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="main-content">
        <div class="container">
            <h1 class="main-title">Создание нового теста</h1>
            <form id="create-test-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div id="step1" class="form-step">
                    <div class="form-group">
                        <label for="subject">Предмет</label>
                        <select id="subject" name="subject" required>
                            <option value="">Выберите предмет</option>
                            {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.subject }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="next-btn" onclick="showStep(2)">Далее</button>
                </div>

                <div id="step2" class="form-step" style="display: none;">
                    <div class="form-group">
                        <label for="task_name">Название теста</label>
                        <input type="text" id="task_name" name="task_name" required>
                    </div>
                    <button type="button" class="next-btn" onclick="checkTaskName()">Далее</button>
                </div>

                <div id="step3" class="form-step" style="display: none;">
                    <div id="tasks-container">
                        <div class="task">
                            <div class="form-group">
                                <label for="task_content">Содержание задания</label>
                                <textarea id="task_content" name="task_content" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="task_photo">Фото (необязательно)</label>
                                <input type="file" id="task_photo" name="task_photo" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label for="correct_answer">Правильный ответ</label>
                                <input type="text" id="correct_answer" name="correct_answer" required>
                            </div>
                            <div class="form-group">
                                <label for="wrong_1">Неправильный ответ 1</label>
                                <input type="text" id="wrong_1" name="wrong_1" required>
                            </div>
                            <div class="form-group">
                                <label for="wrong_2">Неправильный ответ 2</label>
                                <input type="text" id="wrong_2" name="wrong_2" required>
                            </div>
                            <div class="form-group">
                                <label for="wrong_3">Неправильный ответ 3</label>
                                <input type="text" id="wrong_3" name="wrong_3" required>
                            </div>
                            <div class="form-group">
                                <label for="task_hint">Подсказка (необязательно)</label>
                                <textarea id="task_hint" name="task_hint" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-task-btn" onclick="addTask()">Добавить задание</button>
                    <button type="submit" class="submit-btn">Сохранить тест</button>
                </div>
            </form>
        </div>
    </main>

    <script>
        function showStep(step) {
            if (step === 2) {
                const subject = document.getElementById('subject').value;
                if (!subject) {
                    alert('Пожалуйста, выберите предмет.');
                    return;
                }
            }
            if (step === 3) {
                const taskName = document.getElementById('task_name').value;
                if (!taskName) {
                    alert('Пожалуйста, введите название теста.');
                    return;
                }
            }
            document.querySelectorAll('.form-step').forEach((stepDiv) => {
                stepDiv.style.display = 'none';
            });
            document.getElementById('step' + step).style.display = 'block';
        }

        function checkTaskName() {
            const taskName = document.getElementById('task_name').value;
            fetch(`/check_task_name/?task_name=${taskName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        alert('Название теста уже существует. Пожалуйста, выберите другое.');
                    } else {
                        showStep(3);
                    }
                });
        }

        function addTask() {
            const tasksContainer = document.getElementById('tasks-container');
            const newTask = tasksContainer.querySelector('.task').cloneNode(true);
            newTask.querySelectorAll('input, textarea').forEach(input => {
                input.value = '';
            });
            tasksContainer.appendChild(newTask);
        }

        document.getElementById('create-test-form').addEventListener('submit', function(event) {
            const tasks = document.querySelectorAll('.task');
            for (let task of tasks) {
                const taskContent = task.querySelector('textarea[name="task_content"]').value;
                const correctAnswer = task.querySelector('input[name="correct_answer"]').value;
                const wrong1 = task.querySelector('input[name="wrong_1"]').value;
                const wrong2 = task.querySelector('input[name="wrong_2"]').value;
                const wrong3 = task.querySelector('input[name="wrong_3"]').value;

                if (!taskContent || !correctAnswer || !wrong1 || !wrong2 || !wrong3) {
                    alert('Пожалуйста, заполните все обязательные поля для каждого задания.');
                    event.preventDefault();
                    return;
                }
            }
        });
    </script>
</body>
</html>
